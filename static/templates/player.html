<!DOCTYPE html>
<html lang="{{request.state.lang}}">

<head>
    <meta charset="utf-8" />
    <title>{{ data.app.title }} - Player</title>
    <meta name="renderer" content="webkit" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <!-- jquery -->
    <script src="static/js/jquery/jquery.min.js"></script>
    <script src="static/js/ext/xgplayer.js"></script>
    <!-- nprogress -->
    <link href="static/js/nprogress/nprogress.min.css" rel="stylesheet">
    <script src="static/js/nprogress/nprogress.min.js"></script>
    <!-- layui -->
    <link href="static/js/layui/css/layui.css" rel="stylesheet">
    <link href="static/js/layui/css/layui-dark.css" rel="stylesheet">
    <script src="static/js/layui/layui.js"></script>
    <!-- creator -->
    <script src="static/js/app/theme.js"></script>
    <script src="static/js/app/app.js"></script>
    <style>
        #player-container {
            width: 100%;
            background-color: black;
            overflow-y: hidden; /* 隐藏y轴滚动条 */
        }
    </style>
</head>

<body>
    <div class="layui-layout layui-layout-admin">

        <div style="padding: 10px">
            <div class="layui-card layui-panel">
                <!-- <div class="layui-card-header">{{_("视频")}}</div> -->
                <div class="layui-card-body">

                    <div class="layui-form-item layui-col-space15" style="margin-bottom:0px">
                        <div class="layui-col-md10">
                            <div class="layui-input-wrap">
                                <input id="url" value="{{ data.url }}" type="text" placeholder='{{_("请输入任务ID、视频链接")}}' class="layui-input">
                            </div>
                        </div>

                        <div class="layui-col-md2">
                            <div class="layui-input-wrap">
                                <button id="play" type="button" class="layui-btn layui-btn-primary layui-border-blue layui-btn-fluid">{{_("播放")}}</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="layui-card layui-panel" style="padding-top: 15px; background-color: black;">
                <div id="player-container"></div>
            </div>
        </div>
    </div>

    <script>

        let player;

        layui.use(['layer', 'util', 'tool', 'i18n'], function () {

            var layer = layui.layer;
            var util = layui.util;
            var tool = layui.tool;
            var i18n = layui.i18n;
            var $ = layui.$;

            i18n.init('{{request.state.lang}}');

            var autoplay = layui.url().search.autoplay;

            // 预览事件
            $('#play').on('click', function () {
                const input_url = $("#url").val();
                if (input_url.length != 17) {
                    return video_play(input_url)
                }
                tool.get("/result/" + input_url, {}, function (response) {
                    console.debug(JSON.stringify(response, null, 2))
                    if (response.code == 0) {
                        video_play(response.data.result.video_dub)
                    } else {
                        layer.msg(i18n.trans("获取视频信息失败") + ": " + (response.msg || "未知错误"));
                    }
                }, true, function(error) {
                    layer.msg(i18n.trans("请求失败，请检查网络连接"));
                    console.error("API request failed:", error);
                });
            });

            // 资源地址
            var build_url = function (url) {
                if (!url.startsWith('http')) {
                    url = `${window.location.protocol}//${window.location.host}/file/local?url=${encodeURIComponent(url)}`;
                }
                return url
            };

            // 视频播放
            var video_play = function (url) {
                if (!url) {
                    layer.msg(i18n.trans("请输入任务ID、视频链接"));
                    return;
                }
                try {
                    if (player) {
                        player.destroy();
                        player = null;
                    }
                    player = new Player({
                        id: "player-container",
                        url: build_url(url),
                        playsinline: true,
                        autoplay: true,
                        // "download": true,
                        pip: true,
                        width: "100%",
                        height: resizePlayer(),
                        volume: 1
                    });
                } catch (error) {
                    layer.msg(i18n.trans("播放器初始化失败"));
                    console.error("Player initialization failed:", error);
                }
            }

            // 监听窗口大小调整，调整播放器高度
            window.addEventListener('resize', function() {
                if (player) {
                    const newHeight = resizePlayer();
                    if(typeof player.resize === 'function') {
                        player.resize(newHeight);
                    } else {
                        // 如果 xgplayer 不支持 resize，重建播放器
                        const currentUrl = player.config.url;
                        player.destroy();
                        player = new Player({
                            id: "player-container",
                            url: currentUrl,
                            playsinline: true,
                            autoplay: false,
                            pip: true,
                            width: "100%",
                            height: newHeight,
                            volume: 1
                        });
                    }
                }
            });

            $(document).ready(function () {
                if (autoplay) {
                    $("#play").click();
                }
            });

            function resizePlayer() {
                // 获取播放器容器
                const playerContainer = document.getElementById('player-container');
                if (!playerContainer) return '360px';
                const playerCard = playerContainer.parentElement;

                // 获取视口高度
                const vh = window.innerHeight;

                // 获取播放器容器距离视口顶部的距离
                const rect = playerCard.getBoundingClientRect();
                const topOffset = rect.top;

                // 获取播放器容器的 padding-top
                const paddingTop = parseInt(window.getComputedStyle(playerCard).paddingTop, 10) || 0;

                // 底部保留空间
                const bottomMargin = 10;

                // 计算可用高度
                let availableHeight = vh - topOffset - paddingTop - bottomMargin;

                // 防止高度过小或负值
                if (availableHeight < 360) {
                    availableHeight = 360;
                }

                return availableHeight + 'px';
            }
        });

    </script>
</body>

</html>
